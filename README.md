# DAMDINOV_LAB_3

<?php
session_start();

// Пример неправильной защиты от CSRF (CWE-352)
// Не проверяется CSRF токен, что позволяет злоумышленнику отправить запрос от имени пользователя
if ($_POST['csrf_token'] !== $_SESSION['csrf_token']) {
    die("Ошибка CSRF.");
}

// Использование MD5 для хеширования паролей (CWE-323)
// MD5 устарел и небезопасен. Используйте более безопасные методы, например, password_hash() с bcrypt
$pass = md5($_POST['password']); // Плохая практика

// Подготовленные выражения для предотвращения SQL-инъекций (CWE-89)
// Прямое использование переменных в SQL-запросах уязвимо для SQL-инъекций
$stmt = $mysqli->prepare("SELECT * FROM users WHERE user = ? AND password = ?");
$stmt->bind_param('ss', $_POST['username'], $pass);  // Подготовленные выражения безопасны
$stmt->execute();
$result = $stmt->get_result();

// Если вход успешен
if ($result && mysqli_num_rows($result) == 1) {
    // Получаем детали пользователя
    $row = mysqli_fetch_assoc($result);
    $avatar = htmlspecialchars($row['avatar'], ENT_QUOTES, 'UTF-8');  // Экранлирование данных для предотвращения XSS (CWE-79)
    echo "<p>Добро пожаловать в защищенную область.</p>";
    echo "<img src=\"{$avatar}\" />";
} else {
    // Отображаем общее сообщение, чтобы избежать утечек информации (CWE-209)
    echo "<pre><br />Неверное имя пользователя и/или пароль.</pre>";
}

// Пример защиты от брутфорса (CWE-307)
// Если слишком много неудачных попыток входа, заблокировать запросы
// Предполагается использование лимита попыток в базе данных или сессионной информации
if ($failed_attempts >= 5) {
    die("Слишком много неудачных попыток. Попробуйте снова позже.");
}

$stmt->close();
?>
